# 브라우저 동작 원리

브라우저의 핵심 기능은 사용자가 참조하고자 하는 웹페이지를 서버에 요청하고 서버의 응답을 받아 브라우저에 표시하는 것이다. 

브라우저는 서버로부터 HTML, CSS Javascript, 이미지 파일 등을 응답받는다.

### HTML, CSS

------

HTML, CSS 파일은 렌더링 엔진의 HTML 파서와 CSS 파서에 의해 파싱되어 DOM, CSSOM 트리로 변환되고 렌더 트리로 결합된다. 이렇게 생성된 렌더 트리를 기반으로 브라우저는 웹페이지를 표시한다.

HTML 파싱 과정은 바이트를 문자로 변환하고, 토큰을 식별한 후 노드로 변환해서 DOM 트리를 빌드한다.

파싱은 위에서 아래로 진행하는데, 그러다가 link나 style같이 CSS를 불러오는 태그들을 만나면 렌더링 엔진은 DOM의 생성을 일시적으로 중단하고 CSS 파일을 요청해 받아온다.

CSS 파싱 과정이 끝나고 코드에서 명세한 내용과 순서를 바탕으로 DOM과 같은 트리를 구성하는데 이를 CSSOM 트리라 부르고, 이 트리에는 스타일, 규칙, 선택자 등의 정보가 노드에 들어가게 된다.

렌더 트리는 기본적으로 화면에 나타나는 요소들을 결정하는 트리이다. 즉, 어떠한 요소들이 보여야 하는지, 어떤 스타일이 적용되어야 하는지, 그리고 어떤 순서로 나타낼 것인지를 명세하는 트리이다.

### Javascript

------

자바스크립트는 렌더링 엔진이 아닌 자바스크립트 엔진(예, 크롬의 V8엔진)이 처리한다. HTML 파서는 script 태그를 만나면 자바스크립트 코드를 실행하기 위해 DOM 생성 프로세스를 중지하고 자바스크립트 엔진으로 제어 권한을 넘긴다. 제어 권한을 넘겨 받은 자바스크립트 엔진은 script 태그 내의 자바스크립트 코드 또는 script 태그의 src 어트리뷰트에 정의된 자바스크립트 파일을 로드하고 파싱하여 실행한다. 

자바스크립트의 실행이 완료되면 다시 HTML 파서로 제어 권한을 넘겨서 브라우저가 중지했던 시점부터 DOM 생성을 재개한다.

### script 태그가 가장 마지막에 위치해야 하는 이유

------

브라우저의 렌더링 과정은 HTML 문서로부터 시작한다. 파싱하는 과정 중에 CSS나 Javascript 태그들을 만났을 때는 DOM 생성을 중지하고 CSS 파일을 파싱하거나, 자바스크립트 엔진으로 제어권한을 넘기게 된다.

하지만 만약 DOM의 생성이 완료되지 않은 상황에서 자바스크립트 코드를 실행하고 코드에서 아직 생성되지 않은 DOM에 접근해 조작하려고 한다면 에러가 발생할 수 있다. 그래서 가장 마지막에 script 태그가 위치하면, DOM의 생성이 완료되었기 때문에 이를 조작한다 해도 문제가 발생하지 않는다. 

그리고 스트립트 태그를 마지막에 위치시키게 되면 자바스크립트가 실행되기 전에 DOM의 생성이 완료되어 렌더링되기 때문에, 페이지의 로딩 시간이 단축된다는 이점이 있다. 

렌더 트리 구성이 끝나면 레이아웃 단계가 이어진다. 이 단계에서는 렌더 트리에서 계산되지 않았던 노드들의 크기와 위치, 레이어 간 순서와 같은 정보를 계산하여 좌표에 나타낸다.

마지막 페인트 단계, 말그대로 레이아웃 단계를 통해 화면에 배치된 엘리먼트들에게 색을 입히고 레이어의 위치를 결정하는 단계이다.